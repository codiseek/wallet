{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- PWA мета-теги -->
    <meta name="application-name" content="coinza">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="coinza">
    <meta name="description" content="Приложение для учета личных финансов">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3b82f6">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="{% static 'main/icons/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'main/icons/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'main/icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="167x167" href="{% static 'main/icons/icon-152x152.png' %}">

    <!-- Manifest -->
    <link rel="manifest" href="{% static 'main/manifest.json' %}">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'main/icons/icon-32x32.png' %}" sizes="32x32">
    <link rel="icon" type="image/png" href="{% static 'main/icons/icon-16x16.png' %}" sizes="16x16">

    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Coinza - Управляй финансами просто!</title>
    <meta name="theme-color" content="#0f172a">

    <!-- CDN и локальные стили -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'main/style.css' %}">
</head>

<body class="gradient-bg text-gray-100 min-h-screen">
    <form style="display:none;">{% csrf_token %}</form>

    <!-- Основной контейнер приложения -->
    <div class="app-container">

{% include "main/header.html" %}


<!-- Главная вкладка -->
        <div class="mobile-tab active" id="tab-home">
           <div class="mobile-section">
                <div class="mobile-content"> 
{% include "main/balance.html" %}
{% include "main/category_slider.html" %}
{% include "main/transaction_history.html" %}

 </div></div></div>
 
{% include "main/todo_page.html" %}
{% include "main/category_page.html" %}
{% include "main/stats_page.html" %}      
{% include "main/note_page.html" %}
{% include "main/panel_page.html" %}

                    
</div>
        


{% include "main/navigation.html" %}


    <!-- Подключение модалок -->



    {% include "includes/modals/notification.html" %}
    {% if user.is_staff %}
    {% include "includes/modals/create_notification.html" %}
    {% endif %}

    {% include "includes/modals/change_password.html" %}
    {% include "includes/modals/transaction_detail.html" %}
    {% include "includes/modals/transaction.html" %}
    {% include "includes/modals/category_selection.html" %}
    {% include "includes/modals/category_detail.html" %}
    {% include "includes/modals/category.html" %}
    {% include "includes/modals/note.html" %}
    {% include "includes/modals/view_note.html" %}
    {% include "includes/modals/open_notif.html" %}
    {% include "includes/modals/todo.html" %}


<script>
    // Передаем текущую валюту из Django в JavaScript
    window.currentCurrency = '{{ user_currency }}' || 'c';
    console.log('Текущая валюта из Django:', '{{ user_currency }}');
</script>

<script>
    // Определяем isAdmin для JavaScript
    window.isAdmin = {% if user.is_staff %}true{% else %}false{% endif %};
</script>



<!-- index.html - обновляем блок с балансом -->
<script>
    window.initialBalances = {
        total: {{ total|default:0 }},
        income: {{ income|default:0 }},
        expense: {{ expense|default:0 }},
        total_reserve: {{ current_reserve|default:0 }},
        monthly_reserve: {{ monthly_reserve|default:0 }}  // добавляем месячный резерв
    };
    window.initialReservePercentage = {{ reserve_percentage|default:0 }};
    window.initialTargetReserve = {{ target_reserve|default:0 }};
</script>

<!-- Подключение Tailwind и JS -->
<script src="https://cdn.tailwindcss.com"></script>

<script src="/static/main/utils.js"></script>
<script src="/static/main/modals.js"></script>
<script src="/static/main/notification-logo.js"></script>
<script src="/static/main/currency.js"></script>
<script src="/static/main/balance.js"></script>
<script src="/static/main/categories.js"></script>
<script src="/static/main/categories-modal.js"></script>
<script src="/static/main/notes.js"></script>  
<script src="/static/main/admin.js"></script>     
<script src="/static/main/transactions.js"></script>
<script src="/static/main/savings.js"></script>
<script src="/static/main/navigation.js"></script>
<script src="/static/main/admin.js"></script> 
<script src="/static/main/todo.js"></script> 
<script src="/static/main/app.js"></script>

    <script>
        // Переменная для отслеживания первой смены пароля
        let isFirstPasswordChange = {% if not user.userprofile.password_changed %}true{% else %}false{% endif %};

        // Функции для управления модалкой смены пароля
        function toggleChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            const closepassBtn = modal ? modal.querySelectorAll('.close-modal, [data-modal="passbtn"]') : [];
            modal.classList.toggle('hidden');
            
 // Кнопки закрытия
    closepassBtns.forEach(btn => {
        btn.addEventListener('click', () => animateModal(modal, false));
    });
            // Сбрасываем форму
            document.getElementById('changePasswordForm').reset();
            
            // Сбрасываем состояние кнопки
            setChangePasswordButtonLoading(false);
            document.querySelector('.change-password-submit-btn').classList.add('btn-primary');
            document.querySelector('.change-password-submit-btn').classList.remove('bg-red-600', 'cursor-not-allowed', 'bg-green-600');
        }

        

        // Функции для управления состоянием кнопки смены пароля
        function setChangePasswordButtonLoading(isLoading) {
            const btn = document.querySelector('.change-password-submit-btn');
            const btnText = btn.querySelector('.change-password-btn-text');
            const spinner = btn.querySelector('.change-password-spinner');
            
            if (btn && btnText && spinner) {
                if (isLoading) {
                    btn.disabled = true;
                    btnText.classList.add('opacity-0');
                    spinner.classList.remove('hidden');
                } else {
                    btn.disabled = false;
                    btnText.classList.remove('opacity-0');
                    spinner.classList.add('hidden');
                }
            }
        }

        function showChangePasswordButtonError(errorMessage) {
            const btn = document.querySelector('.change-password-submit-btn');
            const btnText = btn.querySelector('.change-password-btn-text');
            const spinner = btn.querySelector('.change-password-spinner');
            
            if (btn && btnText && spinner) {
                // Сохраняем оригинальный текст
                const originalText = btnText.textContent;
                
                // Показываем ошибку
                btn.disabled = true;
                spinner.classList.add('hidden');
                btnText.classList.remove('opacity-0');
                btnText.textContent = errorMessage;
                btn.classList.remove('btn-primary');
                btn.classList.add('bg-red-600', 'cursor-not-allowed');
                
                // Через 4 секунды возвращаем нормальное состояние
                setTimeout(() => {
                    btn.disabled = false;
                    btnText.textContent = originalText;
                    btn.classList.add('btn-primary');
                    btn.classList.remove('bg-red-600', 'cursor-not-allowed');
                }, 2000);
            }
        }

        function showChangePasswordButtonSuccess(successMessage) {
            const btn = document.querySelector('.change-password-submit-btn');
            const btnText = btn.querySelector('.change-password-btn-text');
            const spinner = btn.querySelector('.change-password-spinner');
            
            if (btn && btnText && spinner) {
                // Показываем успех
                btn.disabled = true;
                spinner.classList.add('hidden');
                btnText.classList.remove('opacity-0');
                btnText.textContent = successMessage;
                btn.classList.remove('btn-primary');
                btn.classList.add('bg-green-600', 'cursor-not-allowed');
                
                // Только при первой смене пароля закрываем модалки и перезагружаем страницу
                if (isFirstPasswordChange) {
                    setTimeout(() => {
                        toggleChangePasswordModal();
                        toggleMenuModal();
                        location.reload();
                    }, 2000);
                } else {
                    // При повторной смене просто сбрасываем форму через 2 секунды
                    setTimeout(() => {
                        document.getElementById('changePasswordForm').reset();
                        setChangePasswordButtonLoading(false);
                        btn.classList.add('btn-primary');
                        btn.classList.remove('bg-green-600', 'cursor-not-allowed');
                        btnText.textContent = "Сохранить пароль";
                    }, 2000);
                }
            }
        }

        // Обработчик кнопки смены пароля
        document.getElementById('changePasswordBtn').addEventListener('click', function() {
            toggleChangePasswordModal();
            
            // Показываем поле для текущего пароля, если пользователь уже менял пароль
            const currentPasswordField = document.getElementById('currentPasswordField');
            if ({{ user.userprofile.password_changed|yesno:"true,false" }}) {
                currentPasswordField.classList.remove('hidden');
                currentPasswordField.querySelector('input').required = true;
            } else {
                currentPasswordField.classList.add('hidden');
                currentPasswordField.querySelector('input').required = false;
            }
        });

        // Закрытие модалки по клику вне окна
        document.getElementById('changePasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleChangePasswordModal();
            }
        });



        // AJAX смена пароля
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            
            // Показываем загрузку на кнопке
            setChangePasswordButtonLoading(true);

            const formData = new FormData(form);
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');
            const currentPassword = formData.get('current_password');

            // Валидация
            if (newPassword !== confirmPassword) {
                showChangePasswordButtonError("Пароли не совпадают");
                return;
            }

            if (newPassword.length < 6) {
                showChangePasswordButtonError("Пароль должен быть не менее 6 символов");
                return;
            }

            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

            try {
                const response = await fetch("{% url 'change_password' %}", {
                    method: "POST",
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    // Успешная смена пароля
                    showChangePasswordButtonSuccess(data.message || "Пароль изменен!");
                    
                    // После первой успешной смены устанавливаем флаг в false
                    if (isFirstPasswordChange) {
                        isFirstPasswordChange = false;
                    }
                } else {
                    showChangePasswordButtonError(data.error || "Ошибка при смене пароля");
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showChangePasswordButtonError("Ошибка соединения");
            }
        });
    </script>

  <script>

  
    // Передаем категории из Django в JavaScript
    window.categories = [
        {% for cat in categories %}
        {
            id: "{{ cat.id }}",
            name: "{{ cat.name|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Передача URL из Django в JavaScript
    window.ADD_TRANSACTION_URL = "{% url 'add_transaction' %}";
    window.STATIC_URL = "{% static '' %}";

  

    // Флаг нового пользователя для показа приветствия
    window.isNewUser = {% if is_new_user %}true{% else %}false{% endif %};


    // Инициализация при загрузке страницы
    document.addEventListener("DOMContentLoaded", function() {


        
        
        // Скрываем пустое состояние для фильтрованных категорий
        const emptyStateFiltered = document.getElementById('emptyStateFiltered');
        if (emptyStateFiltered) {
            emptyStateFiltered.classList.add('hidden');
        }
        
        // Инициализация системы фильтрации
        if (typeof window.initTransactionFilter === 'function') {

            window.initTransactionFilter();
        } else {
            console.error('Функция initTransactionFilter не найдена');
        }
        
        // Инициализация вкладок категорий
        if (typeof window.updateCategoryTabsHandlers === 'function') {
            window.updateCategoryTabsHandlers();
        }
    });
</script>

    

</body>
</html>